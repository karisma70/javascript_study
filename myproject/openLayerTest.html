<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Accessible Map</title>
    <link rel="stylesheet" href="https://openlayers.org/en/v4.1.1/css/ol.css" type="text/css;">
    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="https://code.jquery.com/jquery-2.2.3.min.js"></script>

    <script type="text/javascript" src="lib/binaryajax.js"></script>
    <script type="text/javascript" src="src/binarywrapper.js"></script>
    <script type="text/javascript" src="src/shapefile.js"></script>
    <script type="text/javascript" src="src/dbf.js"></script>
    <script type="text/javascript" src="src/shapedownload.js"></script>
    <script type="text/javascript" src="src/openLayersControl.js"></script>
    <script type = "text/javascript" src = "httpRequest.js"></script>

    <script src="openLayers_v4.1.1/ol.js"></script>

    <style>
        a.skiplink {
            position: absolute;
            clip: rect(1px, 1px, 1px, 1px);
            padding: 0;
            border: 0;
            height: 1px;
            width: 1px;
            overflow: hidden;
        }
        a.skiplink:focus {
            clip: auto;
            height: auto;
            width: auto;
            background-color: #fff;
            padding: 0.3em;
        }
        #map:focus {
            outline: #4A74A8 solid 0.15em;
        }
    </style>
</head>
<body>
<a class="skiplink" href="#map">Go to map</a>
<div id="map" class="map" tabindex="0"></div>
<button id="zoom-out">Zoom out</button>
<button id="zoom-in">Zoom in</button>
<button id="pan-to-nazareth">나사렛</button>
<button id="pan-to-damascus">다메섹</button>

<div id ="container" style="width:1200px">
     <div id="menu" style="background-color:#EEFCB4; text-align: left; width: 1200px; height: 100px; float: left;"><br>
        <form name="bibleSearch" accept-charset="utf-8">
            <input type="text" name="title" size="8"> 권
            <input type="text" name="chapter" size="3"> 장
            <input type="text" name="paragraph" size="3"> 절
            <input type="button" value="검색" onclick="requestBibleByChapter()">
        </form>
        <br>
        <form name="bibleWordSearch" accept-charset="utf-8">
            <input type="text" name="word" size="8"> 검색어
            <input type="button" value="검색" onclick="requestBibleByWord()">
        </form>
        <br>
    </div>
    <div class="map" id = "physical" style = "background-color : #6797FF;"></div>
    <div id ="receiveMsg" style="background-color:#eee; clear: both;">
    </div>
</div>

<script>

    var nazareth = [ 3930131.5467687743,3856253.586329119 ];
    var damascus = [ 4042817.037061023,3963251.110387449 ];

    var wmsLayer1 = new ol.layer.Tile({
        source: new ol.source.Stamen({
            layer: 'terrain-background'
        })
    });

    wmsLayer1.set( 'id', 1, false );
    wmsLayer1.set( 'visibleRange', { max : 12, min : 1 }   );

    var wmsLayer2 = new ol.layer.Tile({
        source: new ol.source.OSM({
            // attributions: [
            //    'All maps © <a href="https://www.opencyclemap.org/">OpenCycleMap</a>',
            //     ol.source.OSM.ATTRIBUTION
            // ],
            url : 'https://{a-c}.tile.thunderforest.com/landscape/{z}/{x}/{y}.png?apikey=bc6eff89a9cc457995e03c54c19e24d5'   // Open Cycle Map
        })
    });

    wmsLayer2.set( 'id', 2, false );
    wmsLayer2.set( 'visibleRange', { max : 16, min : 12 }   );

    var view = new ol.View({
        center: [3942321.454123089,3792452.570684223],
        maxZoom : 16,
        minZoom : 5,
        zoom: 7
        // // center: [703365.7089403362, 5714629.865071137],
        // center: [1347915.6039902964, 4782812.903769424],
        // zoom: 7
    })

    var map = new ol.Map({
        layers: [ wmsLayer1, wmsLayer2 ],
        target: 'map',
        controls: ol.control.defaults({
            attributionOptions:  ({    // @type {olx.control.AttributionOptions}
                collapsible: false
            })
        }),
        view: view
    });

    var layerContainer = {
        layers : [],
        totalCount : 6
    };

     //////////////////////////////////////////////////////

    new ShapeFileDownload( 'naturalearthdata/cultural/110m-admin-0-countries',  3,
        {
            visibleRange : { max : 16, min : 1 },
            fillColor : 'rgba( 255, 255, 255, 0.001)',
            lineStroke : {  color: [234, 179, 74], width : 2, opacity: 0.01  },
            textStroke : { prop: 'Name2', align: 'center', baseline: 'middle', font : 'bold 18px Areal', color: 'white', outlineColor : 'black', outlineWidth : 3  }
        }, layerContainer, map );


    new ShapeFileDownload( 'biblemap/israel_pale/river_polyline',  4,
            {
                visibleRange : { max : 16,  min : 8 },
                fillColor : 'rgba(0, 0, 255, 0.01)',
                lineStroke : {  color: [134, 211, 249], width : 2, opacity: 0.001  }   // water color
            }, layerContainer, map );

    new ShapeFileDownload( 'biblemap/AD_admin_poi',  5,
            {
                visibleRange : { max : 16 , min : 6 },
                fillColor : 'rgba(0, 0, 255, 0.01)',
                lineStroke : {  color: [234, 179, 74], width : 2, opacity: 0.001  },
                textStroke : { prop: 'name', align: 'center', baseline: 'top', font : 'bold 16px Areal', color: 'blue', outlineColor : 'white', outlineWidth : 2  }
            }, layerContainer, map );


    new ShapeFileDownload( 'biblemap/AD_israel_admin_poi',  6,
            {
                visibleRange : { max : 16 , min : 7 },
                fillColor : 'rgba(0, 0, 255, 0.01)',
                lineStroke : {  color: [234, 179, 74], width : 1, opacity: 0.001  },
                textStroke : { prop: 'name', align: 'center', baseline: 'top', font : 'bold 15px Areal', color: 'blue', outlineColor : 'white', outlineWidth : 1  }
            }, layerContainer, map );

    // new ShapeFileDownload( 'naturalearthdata/cultural/110m-populated-places',
    new ShapeFileDownload( 'biblemap/bible_map_poi',  8,
            {
                visibleRange : { max : 16 , min : 7 },
                fillColor : 'rgba(0, 0, 255, 0.01)',
                lineStroke : {  color: [234, 179, 74], width : 1, opacity: 0.001  },
                textStroke : { prop: 'name', align: 'center', baseline: 'top', font : 'bold 14px Areal', color: [36, 38, 132 ], outlineColor : "white", outlineWidth : 1  }
            }, layerContainer, map );

    new ShapeFileDownload( 'biblemap/jesus_move',  9,
            {
                visibleRange : { max : 16 , min : 13 },
                fillColor : 'rgba(0, 0, 255, 0.01)',
                lineStroke : {  color: [234, 179, 74], width : 3, opacity: 0.001  },
                textStroke : { prop: 'name', align: 'center', baseline: 'top', font : 'bold 12px Areal', color: "white", outlineColor : "black", outlineWidth : 3  }
            }, layerContainer, map );



    ///////////////////////////////////////////////////////////////////
    ///////  below is event process!!!

    map.on('click', function(evt) {
        console.log( evt.coordinate );
        var zoom = map.getView().getZoom();
        console.log( "zoom level : " + zoom );

        var layers = map.getLayers();

        layers.forEach( function(layer){
            console.log( layer.get('id') );
        } );
    });


    map.on('precompose', function(evt) {
        var zoom = map.getView().getZoom();
        console.log( "zoom level : " + zoom );

        var layers = map.getLayers();

        layers.forEach( function(layer){
            var visibleRange = layer.get('visibleRange');
            if( typeof visibleRange !== "undefined") {

                if ( visibleRange.min <= zoom && zoom <= visibleRange.max ){
                    layer.setVisible( true );
                }
                else {
                    layer.setVisible( false );
                }
            }
        } );
    });


    document.getElementById('zoom-out').onclick = function() {
        var view = map.getView();
        var zoom = view.getZoom();
        view.setZoom(zoom - 1);
    };

    document.getElementById('zoom-in').onclick = function() {
        var view = map.getView();
        var zoom = view.getZoom();
        view.setZoom(zoom + 1);
    };

    document.getElementById('pan-to-nazareth').onclick = function() {
        flyTo( view, nazareth, function() {});
    };

    document.getElementById('pan-to-damascus').onclick = function() {
        flyTo( view, damascus, function() {});
    };


    function reqeustAndShowContents( searchParam ){
        var jsonStr = JSON.stringify( searchParam );
        console.log( "send param : " + jsonStr );

        url = "http://13.124.86.217:8082?" + jsonStr;
        httpRequest("POST", url, function( http ){
            var resObj = JSON.parse( http.responseText );

            if( resObj.result != "undefined" && resObj.result == "fail" ){
                $('#receiveMsg').append( resObj.error + "\r\n" );
            }
            else {
                var spaceStr = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
                if (resObj.length != "undefined") {    // 배열로 받아올 경우
                    for (idx in resObj) {
                        $('#receiveMsg').append( resObj[idx].title + " " + resObj[idx].chapter + ":" + resObj[idx].paragraph + "<br>" + spaceStr + resObj[idx].content + "<br>");
                    }
                } else {
                    $('#receiveMsg').append(  resObj.title + " " + resObj.chapter + ":" + resObj.paragraph + "<br>" + spaceStr + resObj[idx].content + "<br>");
                }
            }

        } );
    }

    function requestBibleByWord(){
        $('#receiveMsg').empty();
        var searchParam = {
            type: "Word",     // book, chapter, paragraph 등으로 구성된 검색
            option: {}
        };

        if( bibleWordSearch.word.value == "" ){
            alert ("Please insert word! for search!");
        }else{
            searchParam.option.content= { $regex : bibleWordSearch.word.value };   // db.getCollection('bible').find({content: { $regex : "바울" } } );
            // searchParam.option.content= { bibleWordSearch.word.value };
            reqeustAndShowContents( searchParam );
        }

    }

    function requestBibleByChapter(){
        $('#receiveMsg').empty();
        var searchParam = {
            type: "Args",     // book, chapter, paragraph 등으로 구성된 검색
            option: {}
        };

        function consistSearchOpt( obj ){
            searchParam.option[obj.name] = obj.value;
        }

        if( bibleSearch.title.value == "" ){
            alert ("Please insert title!!");
            return;
        } else {
            consistSearchOpt( bibleSearch.title  );
        }

        if( bibleSearch.chapter.value == "" ){
            alert ("Please insert chapter!!");
            return;
        } else {
            consistSearchOpt( bibleSearch.chapter );
        }

        if( bibleSearch.paragraph.value != "" ){
            consistSearchOpt( bibleSearch.paragraph );
        }

        reqeustAndShowContents( searchParam );
    }


</script>
</body>
</html>