<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Accessible Map</title>
    <link rel="stylesheet" href="https://openlayers.org/en/v4.1.1/css/ol.css" type="text/css">
    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="https://code.jquery.com/jquery-2.2.3.min.js"></script>

    <script type="text/javascript" src="lib/binaryajax.js"></script>
    <script type="text/javascript" src="src/binarywrapper.js"></script>
    <script type="text/javascript" src="src/shapefile.js"></script>
    <script type="text/javascript" src="src/dbf.js"></script>

    <script src="openLayers_v4.1.1/ol.js"></script>

    <style>
        a.skiplink {
            position: absolute;
            clip: rect(1px, 1px, 1px, 1px);
            padding: 0;
            border: 0;
            height: 1px;
            width: 1px;
            overflow: hidden;
        }
        a.skiplink:focus {
            clip: auto;
            height: auto;
            width: auto;
            background-color: #fff;
            padding: 0.3em;
        }
        #map:focus {
            outline: #4A74A8 solid 0.15em;
        }
    </style>
</head>
<body>
<a class="skiplink" href="#map">Go to map</a>
<div id="map" class="map" tabindex="0"></div>
<button id="zoom-out">Zoom out</button>
<button id="zoom-in">Zoom in</button>
<button id="pan-to-nazareth">나사렛</button>
<button id="pan-to-damascus">다메섹</button>
<script>

    var nazareth = [ 3930131.5467687743,3856253.586329119 ];
    var damascus = [ 4042817.037061023,3963251.110387449 ];

    var wmsLayer = new ol.layer.Tile({
        source: new ol.source.OSM({
            // attributions: [
            //    'All maps © <a href="https://www.opencyclemap.org/">OpenCycleMap</a>',
            //     ol.source.OSM.ATTRIBUTION
            // ],
            url : 'https://{a-c}.tile.thunderforest.com/landscape/{z}/{x}/{y}.png?apikey=bc6eff89a9cc457995e03c54c19e24d5'
        })
    });

    var map = new ol.Map({
        layers: [ wmsLayer ],
        target: 'map',
        controls: ol.control.defaults({
            attributionOptions:  ({    // @type {olx.control.AttributionOptions}
                collapsible: false
            })
        }),
        view: new ol.View({
            center: [3942321.454123089,3792452.570684223],
             zoom: 7
            // // center: [703365.7089403362, 5714629.865071137],
            // center: [1347915.6039902964, 4782812.903769424],
            // zoom: 7
        })
    });

     //////////////////////////////////////////////////////

 function ShapeFileDownload( url, style, paramMap ) {
     var theLayer = this;
     var shpURL = url+'.shp';
     var dbfURL = url+'.dbf';

     var onShpFail = function ( errCode ) {
        alert('failed to load ' + theLayer.shpURL + ", errCode : " + errCode  );
     };
     var onDbfFail = function ( errCode ) {
        alert('failed to load ' + theLayer.dbfURL + ", errCode : " + errCode  );
     };

     var completeCallback = function( shpFile, style,  dbfFile ){       // callback Function

         var paramStyle = style;

         if ( shpFile.header.shapeType == ShpType.SHAPE_POLYGON ){
             console.log( "download Shape_polygon ");
         }
         if ( shpFile.header.shapeType == ShpType.SHAPE_POLYLINE ){
             console.log( "download Shape_polyline ");
         }
         if ( shpFile.header.shapeType == ShpType.SHAPE_POINT ){
             console.log( "download Shape_point ");
         }

         var bTransform = false;
         if( shpFile.header.boundsXY.width < 1000 ){
             bTransform = true;
         }

         var createTextStyle = function( feature, resolution ){
             var textString = feature.get('name');
             if (textString) {
                 return new ol.style.Text({
                     textAlign: paramStyle.textStroke.align,
                     textBaseline: 'middle',
                     font: paramStyle.textStroke.font,
                     text: feature.get('name'),
                     fill: new ol.style.Fill({color: paramStyle.textStroke.color}),
                     stroke: new ol.style.Stroke({
                         color: paramStyle.textStroke.outlineColor,
                         width: paramStyle.textStroke.outlineWidth
                     }),
                     offsetX: 0,
                     offsetY: 0,
                     rotation: 0
                 });
             } else {
                 return null;
             }
         }

         function pointStyleFunction(feature, resolution) {
             return new ol.style.Style({
                 image: new ol.style.Circle({
                     radius: 10,
                     fill: new ol.style.Fill({color: 'rgba(255, 0, 0, 0.1)'}),
                     stroke: new ol.style.Stroke({color: 'red', width: 1})
                 }),
                 text: createTextStyle(feature, resolution )
             });
         }

         function polygonStyleFunction(feature, resolution ){
             return new ol.style.Style( {
                 stroke: new ol.style.Stroke( {
                     color: style.lineStroke.color,
                     opacity : style.lineStroke.opacity,
                     width: style.lineStroke.width
                 } ),
                 fill: new ol.style.Fill({
                     color: style.fillColor
                 }),
                 text : createTextStyle( feature, resolution )
             });
         }

         var format = new ol.format.WKT();
         var feature = {};
         var features = [];

         var recsLen = shpFile.records.length;
         for (var i = 0; i < recsLen; i++) {
             var record = shpFile.records[i];
             var attrs = dbfFile.records[i];

             // turn shapefile geometry into WKT
             // points are easy!
             if (shpFile.header.shapeType == ShpType.SHAPE_POINT) {
                 var wkt = 'POINT(' + record.shape.x + ' ' + record.shape.y + ')';
                 if( bTransform == true ) {
                     feature = format.readFeature(wkt, {
                         dataProjection : 'EPSG:4326',
                         featureProjection : 'EPSG:3857'
                     });
                 }
                 else {
                     feature = format.readFeature( wkt );
                 }

                 if( style.textStroke.prop ) {
                     var textString = attrs.values[style.textStroke.prop];
                     feature.setProperties({'name': textString});
                 }
                 features.push( feature );
             }

             // lines: not too hard--
             else if (shpFile.header.shapeType == ShpType.SHAPE_POLYLINE) {
                 // prepopulate the first point
                 var points = [];//record.shape.rings[0].x + ' ' + record.shape.rings[0].y];
                 var pointsLen = record.shape.rings[0].length;
                 for (var j = 0; j < pointsLen; j++) {
                     points.push(record.shape.rings[0][j].x + ' ' + record.shape.rings[0][j].y);
                 }

                 var wkt = 'LINESTRING(' + points.join(', ') + ')';
                 if( bTransform == true ) {
                     feature = format.readFeature(wkt, {
                         dataProjection : 'EPSG:4326',
                         featureProjection : 'EPSG:3857'
                     });
                 }
                 else {
                     feature = format.readFeature( wkt );
                 }
                 features.push( feature );
             }

             // polygons: donuts
             else if (shpFile.header.shapeType == ShpType.SHAPE_POLYGON) {
                 var ringsLen = record.shape.rings.length;
                 var wktOuter = [];
                 for (var j = 0; j < ringsLen; j++) {
                     var ring = record.shape.rings[j];
                     if (ring.length < 1)
                         continue;
                     var wktInner = [];//ring.x + ' ' + ring.y];
                     var ringLen = ring.length;
                     for (var k = 0; k < ringLen; k++) {
                         wktInner.push(ring[k].x + ' ' + ring[k].y);
                     }
                     wktOuter.push('(' + wktInner.join(', ') + ')');
                 }

                 var wkt = 'POLYGON(' + wktOuter.join(', ') + ')';
                 var feature = {};

                 if( bTransform == true ) {
                     feature = format.readFeature(wkt, {
                         dataProjection : 'EPSG:4326',
                         featureProjection : 'EPSG:3857'
                     });
                 }
                 else {
                     feature = format.readFeature( wkt );
                 }

                 if( style.textStroke.prop ) {
                     var textString = attrs.values[style.textStroke.prop];
                     feature.setProperties({'name': textString});
                 }
                 features.push( feature );
             }
         }  // end of  for (var i = 0; i < recsLen; i++) {

         var styleFunction;

         if (shpFile.header.shapeType == ShpType.SHAPE_POLYGON || shpFile.header.shapeType == ShpType.SHAPE_POLYLINE ) {
             styleFunction = polygonStyleFunction;
         }else {
             styleFunction = pointStyleFunction;
         }

         var shapeLayer = new ol.layer.Vector({
             source: new ol.source.Vector({
                 features: features
             }),
             style: styleFunction
         });

         paramMap.addLayer( shapeLayer );
     }

     var onShpComplete = function (oHTTP) {
         var binFile = oHTTP.binaryResponse;
         console.log('got data for ' + theLayer.shpURL + ', parsing shapefile');
         theLayer.shpFile = new ShpFile(binFile);
         if (theLayer.dbfFile ){
             completeCallback( theLayer.shpFile, style, theLayer.dbfFile );
         }
     };

     var onDbfComplete = function (oHTTP) {
         var binFile = oHTTP.binaryResponse;
         console.log('got data for ' + theLayer.dbfURL + ', parsing dbf file');

         theLayer.dbfFile = new DbfFile(binFile);
         if (theLayer.shpFile) {
             completeCallback( theLayer.shpFile, style, theLayer.dbfFile );
         }
     };

     this.shpURL = shpURL;
     this.dbfURL = dbfURL;

     var shpLoader = new BinaryAjax(shpURL, onShpComplete, onShpFail);
     var dbfLoader = new BinaryAjax(dbfURL, onDbfComplete, onDbfFail);
 }

    new ShapeFileDownload( 'naturalearthdata/cultural/110m-admin-0-countries',
        {
            fillColor : 'rgba(0, 0, 255, 0.01)',
            lineStroke : {  color: 'green', width : 1, opacity: 0.01  },
            textStroke : { prop: 'Name1', align: 'center', font : 'bold 14px Areal', color: "white", outlineColor : "#fffff", outlineWidth : 3  }
        }, map );

/*
    new ShapeFileDownload( 'naturalearthdata/cultural/110m-admin-0-boundary-lines',
            {
                fillColor : 'rgba(0, 0, 255, 0.01)',
                lineStroke : {  color: [234, 179, 74], width : 2, opacity: 0.001  }
            }, map );
*/


    new ShapeFileDownload( 'naturalearthdata/cultural/110m-populated-places',
            {
                fillColor : 'rgba(0, 0, 255, 0.01)',
                lineStroke : {  color: [234, 179, 74], width : 2, opacity: 0.001  },
                textStroke : { prop: 'Name_Town', align: 'center', font : 'bold 14px Areal', color: "white", outlineColor : "#fffff", outlineWidth : 3  }
            }, map );



    ///////////////////////////////////////////////////////////////////
    ///////  below is event process!!!

    map.on('click', function(evt) {
        console.log( evt.coordinate );
        var zoom = map.getView().getZoom();
        console.log( "zoom level : " + zoom );
    });


    document.getElementById('zoom-out').onclick = function() {
        var view = map.getView();
        var zoom = view.getZoom();
        view.setZoom(zoom - 1);
    };

    document.getElementById('zoom-in').onclick = function() {
        var view = map.getView();
        var zoom = view.getZoom();
        view.setZoom(zoom + 1);
    };

    document.getElementById('pan-to-nazareth').onclick = function() {
        var view = map.getView();
        view.animate({
            center: nazareth,
            duration: 2000
        });
    };

    document.getElementById('pan-to-damascus').onclick = function() {
        var view = map.getView();
        view.animate({
            center: damascus,
            duration: 2000
        });
    };


</script>
</body>
</html>