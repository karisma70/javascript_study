<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Bible Map</title>
    <link rel="stylesheet" href="https://openlayers.org/en/v4.1.1/css/ol.css" type="text/css;">
    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="https://code.jquery.com/jquery-2.2.3.min.js"></script>

    <script type="text/javascript" src="lib/binaryajax.js"></script>
    <script type="text/javascript" src="src/binarywrapper.js"></script>
    <script type="text/javascript" src="src/shapefile.js"></script>
    <script type="text/javascript" src="src/dbf.js"></script>
    <script type="text/javascript" src="src/shapedownload.js"></script>
    <script type="text/javascript" src="src/openLayersControl.js"></script>
    <script type="text/javascript" src="src/contentTextProc.js"></script>
    <script type = "text/javascript" src = "httpRequest.js"></script>

    <script src="openLayers_v4.1.1/ol.js"></script>
    <style>
        table { border-spacing: 2px;
        }
        td { padding:2px;
        }

        .fullscreen:-moz-full-screen {
            height: 100%;
        }
        .fullscreen:-webkit-full-screen {
            height: 100%;
        }
        .fullscreen:-ms-fullscreen {
            height: 100%;
        }

        .fullscreen:fullscreen {
            height: 100%;
        }

        .fullscreen {
            margin-bottom: 10px;
            width: 100%;
            height: 400px;
        }

        .ol-rotate {
            top: 3em;
        }

        .map {
            width: 80%;
            height: 120%;
            outline: "blue solid 0.15em";
            float: left;
        }

        .sidepanel {
            background: white;
            width: 18%;
            height: 120%;
            float: left;
        }

        .sidepanel-title {
            width: 100%;
            font-size: 1em;
            color: #00ffff;
            display: block;
            text-align: center;
        }

        .ol-popup {
            position: absolute;
            background-color: white;
            -webkit-filter: drop-shadow(0 1px 4px rgba(0,0,0,0.2));
            filter: drop-shadow(0 1px 4px rgba(0,0,0,0.2));
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #cccccc;
            bottom: 12px;
            left: -50px;
            min-width: 120px;
        }
        .ol-popup:after, .ol-popup:before {
            top: 100%;
            border: solid transparent;
            content: " ";
            height: 0;
            width: 0;
            position: absolute;
            pointer-events: none;
        }
        .ol-popup:after {
            border-top-color: white;
            border-width: 10px;
            left: 48px;
            margin-left: -10px;
        }
        .ol-popup:before {
            border-top-color: #cccccc;
            border-width: 11px;
            left: 48px;
            margin-left: -11px;
        }
        .ol-popup-closer {
            text-decoration: none;
            position: absolute;
            top: 2px;
            right: 8px;
        }
        .ol-popup-closer:after {
            content: "✖";
        }

       /*  #receiveMsg { background:url("./image/empty_book2.png") no-repeat; background-size: 100% 100% } */

    </style>
</head>
<body>
<div id="fullscreen" class="fullscreen">
    <div class="sidepanel" style = "border: 1px solid black;">
        <!-- <span class="sidepanel-title"> <font  color = "#04520C">Search</font></span> -->
        <form name="bibleSearch" style="font-size:0.8em;" accept-charset="utf-8">
            <br>
            &nbsp<select name="title" style="height:1.7em; font-size:1.0em;" >
            <option>창세기</option><option>출애굽기</option><option>레위기</option><option>민수기</option><option>신명기</option>
            <option>여호수아</option><option>사사기</option><option>룻기</option><option>사무엘상</option><option>사무엘하</option>
            <option>열왕기상</option><option>열왕기하</option><option>역대상</option><option>역대하</option><option>에스라</option>
            <option>느헤미야</option><option>에스더</option><option>욥기</option><option>시편</option><option>잠언</option>
            <option>전도서</option>아가<option>이사야</option><option>예레미야</option><option>예레미야애가</option>
            <option>에스겔</option><option>다니엘</option><option>호세아</option><option>요엘</option><option>아모스</option>
            <option>오바댜</option><option>요나</option><option>미가</option><option>나훔</option><option>하박국</option>
            <option>스바냐</option><option>학개</option><option>스가랴</option><option>말라기</option><option>마태복음</option>
            <option>마가복음</option><option>누가복음</option><option>요한복음</option><option>사도행전</option><option>로마서</option>
            <option>고린도전서</option><option>고린도후서</option><option>갈라디아서</option><option>에베소서</option><option>빌립보서</option>
            <option>골로새서</option><option>데살로니가전서</option><option>데살로니가후서</option><option>디모데전서</option><option>디모데후서</option>
            <option>디도서</option><option>빌레몬서</option><option>히브리서</option><option>야고보서</option><option>베드로전서</option>
            <option>베드로후서</option><option>요한1서</option><option>요한2서</option><option>요한3서</option><option>유다서</option>
            <option>요한계시록</option>
        </select>
            <input type="text" name="chapter" size="2"  style="font-size:1.0em;"> 장
            <input type="button" value="검색" onclick="requestBibleByChapter()">
        </form>
        <br>
        <form name="bibleWordSearch" style="font-size:0.8em;" accept-charset="utf-8">
            &nbsp<input type="text" name="place" size="12" style="font-size:1.0em;"> 지명
            <input type="button" value="검색" style="font-size:1.0em;" onclick="moveToPlace()">
        </form>
        <br>
        <div id = "mouse-position">Mouse Move </div>
    </div>
    <div id="map" class="map"></div>
</div>
<div id="popup" class="ol-popup">
    <a href="#" id="popup-closer" class="ol-popup-closer"></a>
    <div id="popup-content"></div>
</div>
<div id ="receiveMsg" style="border: 1px solid black; position: relative; top: 10px; overflow-y:scroll; width : 98%; height:300px; line-height: 150%; font-size:0.8em; font-family: 돋움체; clear: both;">
</div>


<script>

    bibleSearch.title.value ="출애굽기";
    bibleSearch.chapter.value = 14;
    bibleWordSearch.place.value = "예루살렘";

    var container = document.getElementById('popup');
    var content = document.getElementById('popup-content');
    var closer = document.getElementById('popup-closer');

    var overlay = createOverlay( container );    // container


    ol.Feature.prototype.getLayer = function(map) {
        var this_ = this, layer_, layersToLookFor = [];
        /**
         * Populates array layersToLookFor with only
         * layers that have features
         */
        var check = function(layer){
            var source = layer.getSource();
            if(source instanceof ol.source.Vector){
                var features = source.getFeatures();
                if(features.length > 0){
                    layersToLookFor.push({
                        layer: layer,
                        features: features
                    });
                }
            }
        };
        //loop through map layers
        map.getLayers().forEach(function(layer){
            if (layer instanceof ol.layer.Group) {
                layer.getLayers().forEach(check);
            } else {
                check(layer);
            }
        });
        layersToLookFor.forEach(function(obj){
            var found = obj.features.some(function(feature){
                return this_ === feature;
            });
            if(found){
                //this is the layer we want
                layer_ = obj.layer;
            }
        });
        return layer_;
    };



    var wmsLayer1 = new ol.layer.Tile({
        source: new ol.source.Stamen({
            layer: 'terrain-background'
        })
    });

    wmsLayer1.set( 'id', 1, false );
    wmsLayer1.set( 'visibleRange', { max : 13, min : 1 }   );

    var wmsLayer2 = new ol.layer.Tile({
        source: new ol.source.OSM({
            // attributions: [
            //    'All maps © <a href="https://www.opencyclemap.org/">OpenCycleMap</a>',
            //     ol.source.OSM.ATTRIBUTION
            // ],
            url : 'https://{a-c}.tile.thunderforest.com/landscape/{z}/{x}/{y}.png?apikey=bc6eff89a9cc457995e03c54c19e24d5'   // Open Cycle Map
        })
    });

    wmsLayer2.set( 'id', 2, false );
    wmsLayer2.set( 'visibleRange', { max : 18, min : 13 }   );

    var view = new ol.View({
        center: [3942321.454123089,3792452.570684223],
        maxZoom : 18,
        minZoom : 4,
        zoom: 8

    });

    var scaleLineControl = new ol.control.ScaleLine();
    scaleLineControl.setUnits("metric");

    var raster = new ol.layer.Tile({
        source: new ol.source.OSM()
    });

    raster.set( 'id', 2, false );
    raster.set( 'visibleRange', { max : 18, min : 13 }   );

    var map = new ol.Map({
        // layers: [ wmsLayer1, wmsLayer2 ],
        layers: [ wmsLayer1, raster ],
        overlays: [overlay],
        target: 'map',
        controls: ol.control.defaults({
                attribution : false,
                attributionOptions:  ({    // @type {olx.control.AttributionOptions}
                    collapsible: false
                }) }).
        extend([ new ol.control.FullScreen({
            source: 'fullscreen'
        }), scaleLineControl]),
        view: view
    });

    var layerManager = new LayerManager();

    function addAllLayersToMap( layerContainer ){
        layerContainer.layers.sort( function( layerA, layerB ){
            var aID = layerA.get( 'id' );
            var bID = layerB.get( 'id' );
            if( aID < bID )
                return -11;
            if( aID > bID )
                return 1;
            return 0;
        } );

        for( idx in layerContainer.layers ){
            console.log( "Inserted Layer ID : " + layerContainer.layers[idx].get( 'id'));
            map.addLayer(  layerContainer.layers[ idx ] );
        }
    }

    (function(){
        for( idx in bibleMapLayers ){
            var layer = bibleMapLayers[idx];
            new ShapeFileDownload( layer.url, layer.order, layer.style, layerManager.getLayerContainer(), addAllLayersToMap );
        }
    }());

    requestBibleByChapter();

    ///////////////////////////////////////////////////////////////

    map.on('precompose', function(evt) {
        var zoom = map.getView().getZoom();
        $("#mouse-position").html( "zoom level : " + zoom ); // + zoom;

        var layers = map.getLayers();

        layers.forEach( function(layer){
            var visibleRange = layer.get('visibleRange');
            if( typeof visibleRange !== "undefined") {

                if ( visibleRange.min <= zoom && zoom <= visibleRange.max ){
                    layer.setVisible( true );
                }
                else {
                    layer.setVisible( false );
                }
            }
        } );
    });

    var clickedPos = null;
    var selectedFeatures = null;

    map.on('click', function(evt) {
        clickedPos = evt.coordinate;
        /*
         var layers = map.getLayers();

         layers.forEach( function(layer){
         console.log( layer.get('id') );
         } );
         */
    });

    map.on('singleclick', function(evt) {
        clickedPos = evt.coordinate;
        //  var hdms = ol.coordinate.toStringHDMS(ol.proj.transform(
//                coordinate, 'EPSG:3857', 'EPSG:4326'));

        if( selectedFeatures )
            selectedFeatures.clear();
    });


    var selectClick = new ol.interaction.Select({
        // layers: [ layer명 ]
        condition: ol.events.condition.click
    });

    map.addInteraction( selectClick );

    selectClick.on('select', function(e) {
        var len = e.target.getFeatures().getLength();
        var selLen = e.selected.length;
        selectedFeatures = e.target.getFeatures();

        if( selLen > 0 ){
            var feature = e.selected[0];
            var posName = feature.get("name");
            var layer = feature.getLayer(map);
            var id = layer.get("id");
            if( id > 1) {   // 전세계 폴리곤 경계가 아닌 경우 검색 단어에 대한 성경검색 요청
                requestBibleByWord(posName, function( ){
                    var pos = layerManager.getPoiByName(posName);
                    var youtube = "";

                    requestPoiInfo(pos.orgName, function (poiObj) {
                        if (poiObj.hasOwnProperty("youtube")) {
                            youtube = poiObj["youtube"];
                        }
                        if (youtube != "") {
                            content.innerHTML = posName + "<br><iframe width=\"320\" height=\"240\" src=\"" + youtube + "\" frameborder = \"0\" allowfullscreen></iframe>" ;
                        } else
                            content.innerHTML = posName;
                    }, function(){
                        content.innerHTML = posName;
                    });
                });
            } else {        // 전세계 폴리곤 경계라면...
                posName = "<현재 국가><br>" + "&nbsp" + posName;
                content.innerHTML = posName;
            }
            overlay.setPosition( clickedPos );
        }
    });

    closer.onclick = function() {
        overlay.setPosition(undefined);
        closer.blur();
        return false;
    };

    function moveToPlace(){

        if( bibleWordSearch.place.value == "" ){
            alert ("Please insert place! for search!");
        }else{
            var placeWord = bibleWordSearch.place.value;
            placeWord = removeSpaceInWord( placeWord );
            // placeWord = placeWord.replace(/^\s*|\s*$/g, ''); // 좌우 공백 제거
            $('#receiveMsg').empty();

            moveToPlaceByWord( placeWord );

            var searchParam = {
                type: "Word",     // book, chapter, paragraph 등으로 구성된 검색
                option: {}
            };
            searchParam.option.content= { $regex : placeWord };   // db.getCollection('bible').find({content: { $regex : "바울" } } );

            reqeustAndShowContents( searchParam, function(){
                var placeWord = searchParam.option.content.$regex;
                var orgName = layerManager.getPoiByName( placeWord ).orgName;
                searchParam.option.content= { $regex : orgName };
                reqeustAndShowContents( searchParam, null );
            } );
        }
    }

    function moveToPlaceByWord( word ){
        var pos = layerManager.getPoiByName( word );
        if( word == "예루살렘"){
            pos.zoomIn = 13;
        }

        if( pos ) {
            var curZoom = map.getView().getZoom();
            if( pos.zoomIn <= (curZoom +2) && pos.zoomIn >= (curZoom-2) ){
                moveTo( view, [pos.x, pos.y], pos.zoomIn );
                content.innerHTML = word;
                overlay.setPosition( [pos.x, pos.y]);
            }
            else {
                flyTo(view, [pos.x, pos.y], pos.zoomIn, function (complete) {
                    if (complete == true) {
                        content.innerHTML = word;
                        overlay.setPosition( [pos.x, pos.y]);
                    }
                });
            }
            // moveTo( view, [pos.x, pos.y ] , pos.zoomIn );
        }
    }



    function requestBibleByWord( word, competeCallback ){
        $('#receiveMsg').empty();
        var searchParam = {
            type: "Word",     // book, chapter, paragraph 등으로 구성된 검색
            option: {}
        };

        bibleWordSearch.place.value =  word;

        var searchWord = word;
        searchParam.option.content= { $regex : searchWord };   // db.getCollection('bible').find({content: { $regex : "바울" } } );
        reqeustAndShowContents( searchParam, competeCallback );
    }

    function requestBibleByChapter(){
        $('#receiveMsg').empty();
        var searchParam = {
            type: "Args",     // book, chapter, paragraph 등으로 구성된 검색
            option: {}
        };

        function consistSearchOpt( obj ){
            searchParam.option[obj.name] = obj.value;
        }

        if( bibleSearch.title.value == "" ){
            alert ("Please insert title!!");
            return;
        } else {
            consistSearchOpt( bibleSearch.title  );
        }

        if( bibleSearch.chapter.value == "" ){
            alert ("Please insert chapter!!");
            return;
        } else {
            consistSearchOpt( bibleSearch.chapter );
        }

        /*
        if( bibleSearch.paragraph.value != "" ){
            consistSearchOpt( bibleSearch.paragraph );
        }*/

        reqeustAndShowContents( searchParam, null );
    }

    function requestPoiInfo( poiName, recvFunc,  errFunc){

        var searchParam = {
            type: "Poi",     // book, chapter, paragraph 등으로 구성된 검색
            option: {}
        };

        searchParam.option["name"] = poiName;

        var jsonStr = JSON.stringify( searchParam );

        url = "http://13.124.86.217:8082?" + jsonStr;
        console.log( url );
        httpRequest("POST", url, function( http ) {
            var resObj = JSON.parse( http.responseText );

            if( resObj.result != "undefined" && resObj.result == "fail" ){
                console.log( "requestPoiInfo() Fail!!!   param: " + jsonStr );
                if( errFunc ){
                    errFunc( resObj );
                }
                return;
            }

            if (resObj.length != "undefined") {    // 배열로 받아올 경우
                if( resObj.length < 1){
                    errFunc( resObj );
                    return;
                }
                for( idx in resObj ){
                    var poiObj = resObj[idx];
                    recvFunc( poiObj );
                    break;                  // 여러개 받아오더라도 하나만 처리하도록 한다.
                }
            }
            else{
                 recvFunc( resObj );
            }

        });
    }

    function reqeustAndShowContents( searchParam , completeCallback ){
        var jsonStr = JSON.stringify( searchParam );

        url = "http://13.124.86.217:8082?" + jsonStr;
        console.log( url );
        httpRequest("POST", url, function( http ){
            var resObj = JSON.parse( http.responseText );
            if( resObj.length < 1 ){
                if( completeCallback )
                    completeCallback( resObj );
                return;
            }

            if( resObj.result != "undefined" && resObj.result == "fail" ){
                $('#receiveMsg').append( resObj.error + "\r\n" );
            }
            else {
                $('#receiveMsg').append( "<br><table>");
                var chapterStart =  "<td width = \"120\">&nbsp&nbsp";
                var contentStart = "<td>";
                var endString = "</td>";

                function appendReceiveMsg( chapterStart, endString, resObj, contentStart, strContent ){
                    $('#receiveMsg').append( "<tr>");
                    $('#receiveMsg').append( chapterStart + "<strong>" + resObj.title + " " + resObj.chapter + ":" + resObj.paragraph +"</strong>"+ endString + contentStart + strContent + endString );
                    $('#receiveMsg').append( "</tr>");
                }

                if (resObj.length != "undefined") {    // 배열로 받아올 경우
                    for (idx in resObj) {
                        if( searchParam.type == "Word" ){
                            // var strConvText = makeStrongWordInText(  searchParam.option.content.$regex, resObj[idx].content, '#9C1AC8'  );
                            if( examinRightWordinText( searchParam.option.content.$regex, resObj[idx].content ) == true ){
                                var strConvText = makeStrongInText( layerManager, searchParam.option.content.$regex, resObj[idx].content );
                                appendReceiveMsg( chapterStart, endString, resObj[idx], contentStart, strConvText );
                            }
                        }else {
                            var strConvText = makeStrongWordOfLocation( layerManager, resObj[idx].content );
                            // $('#receiveMsg').append(resObj[idx].title + " " + resObj[idx].chapter + ":" + resObj[idx].paragraph + "<br>" + spaceStr + strConvText + "<br>");
                            appendReceiveMsg( chapterStart, endString, resObj[idx], contentStart, strConvText );
                        }
                    }
                } else {        // 수신받은 데이터가 배열이 아니고 하나만 있을 경우
                    if( searchParam.type == "Word" ){
                        if( examinRightWordinText( searchParam.option.content.$regex, resObj.content ) == true ) {
                            // var strConvText = makeStrongWordInText(  searchParam.option.content.$regex, resObj[idx].content, '#9C1AC8'  );
                            var strConvText = makeStrongInText( layerManager, searchParam.option.content.$regex, resObj.content);
                            // $('#receiveMsg').append(resObj[idx].title + " " + resObj[idx].chapter + ":" + resObj[idx].paragraph + "<br>" + spaceStr + strConvText + "<br>");
                            appendReceiveMsg( chapterStart, endString, resObj, contentStart, strConvText );
                        }
                    } else {
                        var strConvText = makeStrongWordOfLocation( layerManager, resObj.content );
                        // $('#receiveMsg').append(resObj.title + " " + resObj.chapter + ":" + resObj.paragraph + "<br>" + spaceStr + strConvText + "<br>");
                        appendReceiveMsg( chapterStart, endString, resObj, contentStart, strConvText );
                    }
                }
            }
            $('#receiveMsg').append( "<br></table >");
            $('#receiveMsg').append( "<br>" );

            completeCallback( resObj );

        } );    // end of httpRequest
    }


</script>
</body>
</html>