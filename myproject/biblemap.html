<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Bible Map</title>
    <link rel="stylesheet" href="https://openlayers.org/en/v4.1.1/css/ol.css" type="text/css;">
    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="https://code.jquery.com/jquery-2.2.3.min.js"></script>

    <script type="text/javascript" src="lib/binaryajax.js"></script>
    <script type="text/javascript" src="src/binarywrapper.js"></script>
    <script type="text/javascript" src="src/shapefile.js"></script>
    <script type="text/javascript" src="src/dbf.js"></script>
    <script type="text/javascript" src="src/shapedownload.js"></script>
    <script type="text/javascript" src="src/openLayersControl.js"></script>
    <script type="text/javascript" src="src/contentTextProc.js"></script>
    <script type = "text/javascript" src = "httpRequest.js"></script>

    <script src="openLayers_v4.1.1/ol.js"></script>
    <style>
        .fullscreen:-moz-full-screen {
            height: 100%;
        }
        .fullscreen:-webkit-full-screen {
            height: 100%;
        }
        .fullscreen:-ms-fullscreen {
            height: 100%;
        }

        .fullscreen:fullscreen {
            height: 100%;
        }

        .fullscreen {
            margin-bottom: 10px;
            width: 100%;
            height: 400px;
        }

        .ol-rotate {
            top: 3em;
        }

        .map {
            width: 80%;
            height: 140%;
            float: left;
        }

        .sidepanel {
            background: #EEFCB4;
            width: 20%;
            height: 140%;
            float: left;
        }

        .sidepanel-title {
            width: 100%;
            font-size: 2em;
            color: #00ffff;
            display: block;
            text-align: center;
        }

        .ol-popup {
            position: absolute;
            background-color: white;
            -webkit-filter: drop-shadow(0 1px 4px rgba(0,0,0,0.2));
            filter: drop-shadow(0 1px 4px rgba(0,0,0,0.2));
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #cccccc;
            bottom: 12px;
            left: -50px;
            min-width: 120px;
        }
        .ol-popup:after, .ol-popup:before {
            top: 100%;
            border: solid transparent;
            content: " ";
            height: 0;
            width: 0;
            position: absolute;
            pointer-events: none;
        }
        .ol-popup:after {
            border-top-color: white;
            border-width: 10px;
            left: 48px;
            margin-left: -10px;
        }
        .ol-popup:before {
            border-top-color: #cccccc;
            border-width: 11px;
            left: 48px;
            margin-left: -11px;
        }
        .ol-popup-closer {
            text-decoration: none;
            position: absolute;
            top: 2px;
            right: 8px;
        }
        .ol-popup-closer:after {
            content: "✖";
        }
    </style>
</head>
<body>
<div id="fullscreen" class="fullscreen">
    <div id="map" class="map"></div>
    <div id="popup" class="ol-popup">
        <a href="#" id="popup-closer" class="ol-popup-closer"></a>
        <div id="popup-content"></div>
    </div>
    <div class="sidepanel">
        <span class="sidepanel-title">Search</span>
        <form name="bibleSearch" accept-charset="utf-8">
            &nbsp<input type="text" name="title" size="8"> 권
                <input type="text" name="chapter" size="3"> 장
                <input type="button" value="검색" onclick="requestBibleByChapter()">
            </form>
            <br>
        <form name="bibleWordSearch" accept-charset="utf-8">
            &nbsp<input type="text" name="place" size="12"> 성경지명
                <input type="button" value="이동" onclick="moveToPlace()">
            </form>
            <br>
    </div>
</div>
<div id = "mouse-position">Mouse Move </div>
<div id ="receiveMsg" style="overflow:scroll; height:400px; background-color:#eee; font-size:0.9em; font-family: 돋움체; clear: both;"></div>

<script>

    var container = document.getElementById('popup');
    var content = document.getElementById('popup-content');
    var closer = document.getElementById('popup-closer');

    var overlay = createOverlay( container );    // container

    var wmsLayer1 = new ol.layer.Tile({
        source: new ol.source.Stamen({
            layer: 'terrain-background'
        })
    });

    wmsLayer1.set( 'id', 1, false );
    wmsLayer1.set( 'visibleRange', { max : 13, min : 1 }   );

    var wmsLayer2 = new ol.layer.Tile({
        source: new ol.source.OSM({
            // attributions: [
            //    'All maps © <a href="https://www.opencyclemap.org/">OpenCycleMap</a>',
            //     ol.source.OSM.ATTRIBUTION
            // ],
            url : 'https://{a-c}.tile.thunderforest.com/landscape/{z}/{x}/{y}.png?apikey=bc6eff89a9cc457995e03c54c19e24d5'   // Open Cycle Map
        })
    });

    wmsLayer2.set( 'id', 2, false );
    wmsLayer2.set( 'visibleRange', { max : 18, min : 13 }   );

    var view = new ol.View({
        center: [3942321.454123089,3792452.570684223],
        maxZoom : 18,
        minZoom : 5,
        zoom: 8

    });

    var scaleLineControl = new ol.control.ScaleLine();
    scaleLineControl.setUnits("metric");

    var map = new ol.Map({
        layers: [ wmsLayer1, wmsLayer2 ],
        overlays: [overlay],
        target: 'map',
        controls: ol.control.defaults({
            attributionOptions:  ({    // @type {olx.control.AttributionOptions}
                collapsible: false
            })
        }).extend([ new ol.control.FullScreen({
            source: 'fullscreen'
        }), scaleLineControl]),
        view: view
    });

    var layerManager = new LayerManager();


    function addAllLayersToMap( layerContainer ){
        layerContainer.layers.sort( function( layerA, layerB ){
            var aID = layerA.get( 'id' );
            var bID = layerB.get( 'id' );
            if( aID < bID )
                return -11;
            if( aID > bID )
                return 1;
            return 0;
        } );

        for( idx in layerContainer.layers ){
            console.log( "Inserted Layer ID : " + layerContainer.layers[idx].get( 'id'));
            map.addLayer(  layerContainer.layers[ idx ] );
        }
    }

    (function(){
        for( idx in bibleMapLayers ){
            var layer = bibleMapLayers[idx];
            new ShapeFileDownload( layer.url, layer.order, layer.style, layerManager.getLayerContainer(), addAllLayersToMap );
        }
    }());

    map.on('precompose', function(evt) {
        var zoom = map.getView().getZoom();
        $("#mouse-position").html( "zoom level : " + zoom ); // + zoom;

        var layers = map.getLayers();

        layers.forEach( function(layer){
            var visibleRange = layer.get('visibleRange');
            if( typeof visibleRange !== "undefined") {

                if ( visibleRange.min <= zoom && zoom <= visibleRange.max ){
                    layer.setVisible( true );
                }
                else {
                    layer.setVisible( false );
                }
            }
        } );
    });

    var clickedPos = null;
    var selectedFeatures = null;

    map.on('click', function(evt) {
        clickedPos = evt.coordinate;
        /*
         var layers = map.getLayers();

         layers.forEach( function(layer){
         console.log( layer.get('id') );
         } );
         */
    });

    map.on('singleclick', function(evt) {
        clickedPos = evt.coordinate;
        //  var hdms = ol.coordinate.toStringHDMS(ol.proj.transform(
//                coordinate, 'EPSG:3857', 'EPSG:4326'));

        //content.innerHTML = '<p>You clicked here:</p><code>' + hdms +
        // '</code>';
        // content.innerHTML = "I'm a david!";
        // overlay.setPosition(coordinate);
        if( selectedFeatures )
            selectedFeatures.clear();

    });


    var selectClick = new ol.interaction.Select({
        // layers: [ layer명 ]
        condition: ol.events.condition.click
    });

    map.addInteraction( selectClick );

    selectClick.on('select', function(e) {
        var len = e.target.getFeatures().getLength();
        var selLen = e.selected.length;
        selectedFeatures = e.target.getFeatures();

        if( selLen > 0 ){
            var feature = e.selected[0];
            var posName = feature.get("name");
            requestBibleByWord( posName );
            content.innerHTML = posName;
            overlay.setPosition( clickedPos );
        }
    });

    closer.onclick = function() {
        overlay.setPosition(undefined);
        closer.blur();
        return false;
    };

    function moveToPlace(){

        if( bibleWordSearch.place.value == "" ){
            alert ("Please insert place! for search!");
        }else{
            var placeWord = bibleWordSearch.place.value;
            $('#receiveMsg').empty();
            var searchParam = {
                type: "Word",     // book, chapter, paragraph 등으로 구성된 검색
                option: {}
            };
            searchParam.option.content= { $regex : placeWord };   // db.getCollection('bible').find({content: { $regex : "바울" } } );
            reqeustAndShowContents( searchParam );

            moveToPlaceByWord( placeWord );
        }
    }

    function moveToPlaceByWord( word ){
        var pos = layerManager.getPoiByName( word );
        if( word == "예루살렘"){
            pos.zoomIn = 13;
        }

        if( pos ) {
            console.log(pos.x + ", " + pos.y + ", zoomIn : " + pos.zoomIn );
            flyTo( view, [pos.x, pos.y ] , pos.zoomIn, function( complete){
                if( complete == true ){
                    content.innerHTML = word;
                    overlay.setPosition( [pos.x, pos.y] );
                }
            });
            // moveTo( view, [pos.x, pos.y ] , pos.zoomIn );
        }
    }



    function requestBibleByWord( word ){
        $('#receiveMsg').empty();
        var searchParam = {
            type: "Word",     // book, chapter, paragraph 등으로 구성된 검색
            option: {}
        };

        bibleWordSearch.place.value =  word;

        var searchWord = word;
        searchParam.option.content= { $regex : searchWord };   // db.getCollection('bible').find({content: { $regex : "바울" } } );
        reqeustAndShowContents( searchParam );
    }

    function requestBibleByChapter(){
        $('#receiveMsg').empty();
        var searchParam = {
            type: "Args",     // book, chapter, paragraph 등으로 구성된 검색
            option: {}
        };

        function consistSearchOpt( obj ){
            searchParam.option[obj.name] = obj.value;
        }

        if( bibleSearch.title.value == "" ){
            alert ("Please insert title!!");
            return;
        } else {
            consistSearchOpt( bibleSearch.title  );
        }

        if( bibleSearch.chapter.value == "" ){
            alert ("Please insert chapter!!");
            return;
        } else {
            consistSearchOpt( bibleSearch.chapter );
        }

        /*
        if( bibleSearch.paragraph.value != "" ){
            consistSearchOpt( bibleSearch.paragraph );
        }*/

        reqeustAndShowContents( searchParam );
    }

    function reqeustAndShowContents( searchParam ){
        var jsonStr = JSON.stringify( searchParam );

        url = "http://13.124.86.217:8082?" + jsonStr;
        httpRequest("POST", url, function( http ){
            var resObj = JSON.parse( http.responseText );

            if( resObj.result != "undefined" && resObj.result == "fail" ){
                $('#receiveMsg').append( resObj.error + "\r\n" );
            }
            else {
                var spaceStr = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
                if (resObj.length != "undefined") {    // 배열로 받아올 경우
                    for (idx in resObj) {
                        if( searchParam.type == "Word" ){
                            // var strConvText = makeStrongWordInText(  searchParam.option.content.$regex, resObj[idx].content, '#9C1AC8'  );
                            if( examinRightWordinText( searchParam.option.content.$regex, resObj[idx].content ) == true ){
                                var strConvText = makeStrongInText( layerManager, searchParam.option.content.$regex, resObj[idx].content );
                                $('#receiveMsg').append(resObj[idx].title + " " + resObj[idx].chapter + ":" + resObj[idx].paragraph + "<br>" + spaceStr + strConvText + "<br>");
                            }
                        }else {
                            var strConvText = makeStrongWordOfLocation( layerManager, resObj[idx].content );
                            $('#receiveMsg').append(resObj[idx].title + " " + resObj[idx].chapter + ":" + resObj[idx].paragraph + "<br>" + spaceStr + strConvText + "<br>");
                        }
                    }
                } else {
                    if( searchParam.type == "Word" ){
                        if( examinRightWordinText( searchParam.option.content.$regex, resObj[idx].content ) == true ) {
                            // var strConvText = makeStrongWordInText(  searchParam.option.content.$regex, resObj[idx].content, '#9C1AC8'  );
                            var strConvText = makeStrongInText( layerManager, searchParam.option.content.$regex, resObj[idx].content);
                            $('#receiveMsg').append(resObj[idx].title + " " + resObj[idx].chapter + ":" + resObj[idx].paragraph + "<br>" + spaceStr + strConvText + "<br>");
                        }
                    } else {
                        var strConvText = makeStrongWordOfLocation( layerManager, resObj[idx].content );
                        $('#receiveMsg').append(resObj.title + " " + resObj.chapter + ":" + resObj.paragraph + "<br>" + spaceStr + strConvText + "<br>");
                    }
                }
            }

            $('#receiveMsg').append( "<br>" );

        } );
    }


</script>
</body>
</html>